<!DOCTYPE html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>Replacing service dependencies with proxies</title><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel=stylesheet href=/css/140b.blog.css><!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]--><link rel=apple-touch-icon-precomposed sizes=144x144 href=/images/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.ico><link rel=alternate type=application/atom+xml title="Toon Verwerft" href=https://veewee.github.io/atom.xml></head><body class=bs-docs-home><a class=sr-only href=#content>Skip to main content</a><header class="navbar navbar-inverse navbar-fixed-top bs-docs-nav" role=banner><div class=container><div class=navbar-header><button class=navbar-toggle type=button data-toggle=collapse data-target=.bs-navbar-collapse><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button> <a href="/" class=navbar-brand>Toon Verwerft</a></div><nav class="collapse navbar-collapse bs-navbar-collapse" role=navigation><ul class="nav navbar-nav"><li><a href="/">Home</a></li><li><a href=//twitter.com/toonverwerft>Twitter</a></li><li><a href="//github.com/veewee/">Github</a></li><li><a href=//www.linkedin.com/pub/toon-verwerft/36/b90/a2b>LinkedIn</a></li></ul></nav></div></header><a name=#content></a><div id=content><div class=container><div class=row><div class="col-xs-12 col-sm-8 col-md-9 left-pane"><div class=post-details><h1>Replacing service dependencies with proxies</h1><div class=pull-right><span class="meta label label-info">11 Oct 2014</span></div><small>Tags: <a href=/tags/zf2 class="label label-primary tag" title="View posts tagged with &quot;zf2&quot;">zf2</a> <a href=/tags/proxy class="label label-primary tag" title="View posts tagged with &quot;proxy&quot;">proxy</a> <a href=/tags/doctrine class="label label-primary tag" title="View posts tagged with &quot;doctrine&quot;">doctrine</a></small><div class=post><img src=/images/blog/20141011/f402.three-shell-game.jpg class=post-banner alt=""><p>When using the Zend Framework 2 service manager, it is possible to create shared services that will be loaded only once. In some situations however, it is very hard to switch the already injected dependencies in this service. You could mark the service as unshared even if this is often unnecessary. Another solution is to wrap the service with a proxy object and use the proxy instead of the service.</p><h2>Real-life Scenario</h2><p>In an application with multiple tenants, there is one database per tenant. When browsing the application the tenant's database connection is always known. This connection doesn't ever change when browsing the application. Therefor the Doctrine DocumentManager is injected and the services are marked as shared.</p><p>On the server, there are some long-running processes to handle async commands. These processes run globally and are not dependant on a specific tenant. This means that the processes need to switch the DocumentManager based on the tenant they are working for at the moment.</p><p>Off course, the registered services have to work with the current DocumentManager, even if they are marked as shared.</p><h2>Delegators</h2><p>One of the cool features of ZF2 are <a href=http://framework.zend.com/manual/2.3/en/modules/zend.service-manager.delegator-factories.html target=_blank>service delegators</a>. These delegators make it possible to attach or wrap custom functionality to an instance. In this case we will use the delegator to wrap the actual service in a proxy. The instance of the service will still be created in the service manager like before, but instead of returning this instance we will return a proxy object.</p><h2>Proxies</h2><p>In this post, I already talked a lot about using proxies. But what are those proxies?</p><p>The short answer: Proxies are objects that serve as a gateway to the actual object.</p><p>The long answer: There are many different types of proxies. Here you can find a good overview of all <a href=http://ocramius.github.io/presentations/proxy-pattern-in-php target=_blank>proxy patterns</a> in PHP.</p><p>In this specific case, a Virtual Proxy is the right proxy to use. It extends the actual base class and has exactly the same API. An over-simplified proxy of a Doctrine DocumentManager could look like this:</p><div class=highlight><pre><code class=php><span class=cp>&lt;?php</span>

<span class=k>class</span> <span class=nc>DocumentManagerProxy</span>
    <span class=k>extends</span> <span class=nx>DocumentManager</span>
<span class=p>{</span>

    <span class=k>protected</span> <span class=nv>$instance</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>__construct</span><span class=p>(</span><span class=nx>DocumentManager</span> <span class=nv>$instance</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>instance</span> <span class=o>=</span> <span class=nv>$instance</span><span class=p>;</span>
    <span class=p>}</span>
    
    <span class=k>public</span> <span class=k>function</span> <span class=nf>find</span><span class=p>(</span><span class=nv>$className</span><span class=p>,</span> <span class=nv>$id</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=k>return</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>instance</span><span class=o>-&gt;</span><span class=na>find</span><span class=p>(</span><span class=nv>$className</span><span class=p>,</span> <span class=nv>$id</span><span class=p>);</span>
    <span class=p>}</span>
    
    <span class=c1>// ... All other methods of the DocumentManager ...</span>

<span class=p>}</span>
</code></pre></div><p>Because this kind of objects will result in a lot of effort in maintaining, it is better to use a library that automatically generates the proxy objects. One of those libraries is <a href=https://github.com/Ocramius/ProxyManager target=_blank>ProxyManager</a> by Ocramius.</p><h1>Putting it all together</h1><h2>ServiceManager configuration</h2><div class=highlight><pre><code class=php><span class=cp>&lt;?php</span>

<span class=k>return</span> <span class=p>[</span>
    <span class=s1>&#39;factories&#39;</span> <span class=o>=&gt;</span> <span class=p>[</span>
        <span class=s1>&#39;documentmanager&#39;</span> <span class=o>=&gt;</span> <span class=k>new</span> <span class=nx>\DoctrineMongoODMModule\Service\DocumentManagerFactory</span><span class=p>(</span><span class=s1>&#39;manager_key&#39;</span><span class=p>),</span>
        <span class=s1>&#39;Application\DocumentManagerProxyDelegator&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;Application\Factory\DocumentManagerProxyDelegatorFactory&#39;</span><span class=p>,</span>
        <span class=s1>&#39;Application\DynamicDocumentManager&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;Application\Factory\DynamicDocumentManagerFactory&#39;</span><span class=p>,</span>
    <span class=p>],</span>
    <span class=s1>&#39;delegators&#39;</span> <span class=o>=&gt;</span> <span class=p>[</span>
        <span class=s1>&#39;documentmanager&#39;</span> <span class=o>=&gt;</span> <span class=p>[</span><span class=s1>&#39;Application\DocumentManagerProxyDelegator&#39;</span><span class=p>],</span>
    <span class=p>]</span>
<span class=p>];</span>
</code></pre></div><h2>Delegator</h2><p>The delegator is responsible for initializing the actual DocumentManager and creating the proxy object. Another service is added that is responsible for maintaining and loading the different DocumentManagers. Make sure that the proxy initializer returns false, so that the proxy is initialized with the current DocumentManager on every method call.</p><div class=highlight><pre><code class=php><span class=cp>&lt;?php</span>

<span class=k>namespace</span> <span class=nx>Application</span><span class=p>;</span>

<span class=k>use</span> <span class=nx>ProxyManager\Factory\LazyLoadingValueHolderFactory</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Zend\ServiceManager\DelegatorFactoryInterface</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Zend\ServiceManager\ServiceLocatorInterface</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>DocumentManagerProxyDelegator</span> <span class=k>implements</span> <span class=nx>DelegatorFactoryInterface</span>
<span class=p>{</span>

    <span class=sd>/**</span>
<span class=sd>     * @var LazyLoadingValueHolderFactory</span>
<span class=sd>     */</span>
    <span class=k>protected</span> <span class=nv>$proxyFactory</span><span class=p>;</span>

    <span class=sd>/**</span>
<span class=sd>     * @var DynamicDocumentManager</span>
<span class=sd>     */</span>
    <span class=k>protected</span> <span class=nv>$dynamicDocumentManager</span><span class=p>;</span>

    <span class=sd>/**</span>
<span class=sd>     * @param $dynamicDocumentManager</span>
<span class=sd>     * @param $proxyFactory</span>
<span class=sd>     */</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>__construct</span><span class=p>(</span><span class=nv>$dynamicDocumentManager</span><span class=p>,</span> <span class=nv>$proxyFactory</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>dynamicDocumentManager</span> <span class=o>=</span> <span class=nv>$dynamicDocumentManager</span><span class=p>;</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>proxyFactory</span> <span class=o>=</span> <span class=nv>$proxyFactory</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=sd>/**</span>
<span class=sd>     * {@inheritdoc}</span>
<span class=sd>     */</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>createDelegatorWithName</span><span class=p>(</span><span class=nx>ServiceLocatorInterface</span> <span class=nv>$serviceLocator</span><span class=p>,</span> <span class=nv>$name</span><span class=p>,</span> <span class=nv>$requestedName</span><span class=p>,</span> <span class=nv>$callback</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nv>$dynamicDocumentManager</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>dynamicDocumentManager</span><span class=p>;</span>
        <span class=nv>$currentDocumentManager</span> <span class=o>=</span> <span class=nv>$callback</span><span class=p>();</span>
        <span class=nv>$dynamicDocumentManager</span><span class=o>-&gt;</span><span class=na>setCurrentManager</span><span class=p>(</span><span class=nv>$currentDocumentManager</span><span class=p>);</span>

        <span class=nv>$proxy</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>proxyFactory</span><span class=o>-&gt;</span><span class=na>createProxy</span><span class=p>(</span>
            <span class=s1>&#39;Doctrine\ODM\MongoDB\DocumentManager&#39;</span><span class=p>,</span>
            <span class=k>function</span> <span class=p>(</span><span class=o>&amp;</span> <span class=nv>$wrappedObject</span><span class=p>)</span> <span class=k>use</span> <span class=p>(</span><span class=nv>$dynamicDocumentManager</span><span class=p>)</span> <span class=p>{</span>
                <span class=nv>$wrappedObject</span> <span class=o>=</span> <span class=nv>$dynamicDocumentManager</span><span class=o>-&gt;</span><span class=na>getCurrentManager</span><span class=p>();</span>
                <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>);</span>

        <span class=k>return</span> <span class=nv>$proxy</span><span class=p>;</span>
    <span class=p>}</span>

<span class=p>}</span>
</code></pre></div><h2>Delegator Factory</h2><p>The delegator factory creates an instance of the factory. For this example It is very straight forward. If you are planning to use it in production, you might add some extra caching configuration to the proxy factory. This configuration can be based on `<a href=https://github.com/zendframework/zf2/blob/master/library/Zend/ServiceManager/Proxy/LazyServiceFactoryFactory.php target=_blank>Zend\ServiceManager\Proxy\LazyServiceFactoryFactory</a>`.</p><div class=highlight><pre><code class=php><span class=cp>&lt;?php</span>

<span class=k>namespace</span> <span class=nx>Application</span><span class=p>;</span>

<span class=k>use</span> <span class=nx>Application\DocumentManagerProxyDelegator</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>ProxyManager\Factory\LazyLoadingValueHolderFactory</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Zend\ServiceManager\FactoryInterface</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Zend\ServiceManager\ServiceLocatorInterface</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>DocumentManagerProxyDelegatorFactory</span> <span class=k>implements</span> <span class=nx>FactoryInterface</span>
<span class=p>{</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>createService</span><span class=p>(</span><span class=nx>ServiceLocatorInterface</span> <span class=nv>$serviceLocator</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nv>$dynamicDocumentManager</span> <span class=o>=</span> <span class=nv>$serviceLocator</span><span class=o>-&gt;</span><span class=na>get</span><span class=p>(</span><span class=s1>&#39;Application\DynamicDocumentManager&#39;</span><span class=p>);</span>
        <span class=nv>$proxyFactory</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>LazyLoadingValueHolderFactory</span><span class=p>();</span>
        <span class=k>return</span> <span class=k>new</span> <span class=nx>DocumentManagerProxyDelegator</span><span class=p>(</span><span class=nv>$dynamicDocumentManager</span><span class=p>,</span> <span class=nv>$proxyFactory</span><span class=p>);</span>
    <span class=p>}</span>
    
<span class=p>}</span>
</code></pre></div><h2>Dynamic DocumentManager</h2><p>The dynamic DocumentManager is responsible for loading and managing the DocumentManagers. While creating an instance for the DocumentManager, the real instance is injected in the DynamicDocumentManager. An implementation might look like this:</p><div class=highlight><pre><code class=php><span class=cp>&lt;?php</span>

<span class=k>interface</span> <span class=nx>DynamicDocumentManagerInterface</span>
<span class=p>{</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>getCurrentManager</span><span class=p>();</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>setCurrentManager</span><span class=p>(</span><span class=nx>DocumentManager</span> <span class=nv>$documentManager</span><span class=p>);</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>loadForTenant</span><span class=p>(</span><span class=nx>Tenant</span> <span class=nv>$tenant</span><span class=p>);</span>

<span class=p>}</span>
</code></pre></div><p>The `setCurrentManager()` is called by the delegator to set the current manager.</p><p>The `getCurrentManager()` is called while initializing the proxy. This way, the current manager will always be used when using the `documentmanager` in a shared service.</p><p>Before executing a command in the long-running process, the `loadForTenant()` method is being called. This method will close the old manager and reset the service manager keys for all Doctrine services. Finally it will recreate the `documentmanager`, which will trigger the `setCurrentManager()` method again.</p><h1>Final thoughts</h1><p>This technique might look a little bit `hacky`, but is actually a very neat trick to make it easier to change instances on the fly.</p><p>You don't have to mark all services that rely on the DocumentManager as unshared. In the codebase, you can still use the actual instance type in the annotations.</p><p>You might think of some other good use-cases to implement this powerful technique yourself.</p></div><a name=comments></a><div id=disqus_thread></div><script type=text/javascript>var disqus_identifier = '/blog/replacing-service-dependencies-with-proxies';
        var disqus_title = 'Replacing service dependencies with proxies';
        var disqus_url = 'http://veewee.github.io/blog/replacing-service-dependencies-with-proxies';

        // trigger disqus-comments.js
        var embed_disqus_comments = true;</script></div></div><div class="col-xs-12 col-sm-4 col-md-3 right-pane"><h1>whois <small>VeeWee</small></h1><div><img src=/images/1da7.picture.png class="img-thumbnail img-responsive selfie" alt=Selfie></div><div><h2>Hi there!</h2><p>Glad you made it to my blog. Please feel free to take a look around. You will find some interesting stuff, mostly about web development and PHP.</p><p>Still can't get enough of me? Quick! Take a look at my <a href=//twitter.com/toonverwerft>Twitter</a> and <a href="//github.com/veewee/">Github</a> account.</p></div><div class=list-group><a class=list-group-item href=//github.com/veewee/veewee.github.io/issues/new><span class="glyphicon glyphicon-pencil"></span> Contact Me</a> <a class=list-group-item href=/atom.xml><span class="glyphicon glyphicon-pushpin"></span> Subscribe to RSS</a></div></div></div></div></div><script src=/js/b1a7.vendor.js></script><script src=/js/e51f.blog.js></script></body></html>