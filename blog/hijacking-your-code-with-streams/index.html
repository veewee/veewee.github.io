<!DOCTYPE html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>Hijacking your code with streams</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/blog.css><!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]--><link rel=apple-touch-icon-precomposed sizes=144x144 href=/images/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.ico><link rel=alternate type=application/atom+xml title="Toon Verwerft" href=https://veewee.github.io/atom.xml><meta property=og:description content="Lately, you might have noticed that streams are getting more important in the PHP scene. They are for example widely used in PSR-7 and implemented in Diactoros. Yesterday I was scrolling down the issues list of phpspec and bumped in on a pull request. This pull request shows that it is possible to convert code in-memory and later require the modified content to be executed. Wow, that is awesome! Let's take a look at it."><meta property=og:title content="Hijacking your code with streams"><meta property=og:image content=https://veewee.github.io/images/blog/20151026/thumb-hijacking.jpg><meta property=og:image:width content=500><meta property=og:image:height content=375><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@toonverwerft><meta name=twitter:creator content=@toonverwerft><link rel=me href=https://phpc.social/@veewee></head><body class=bs-docs-home><a class=sr-only href=#content>Skip to main content</a><header class="navbar navbar-inverse navbar-fixed-top bs-docs-nav" role=banner><div class=container><div class=navbar-header><button class=navbar-toggle type=button data-toggle=collapse data-target=.bs-navbar-collapse><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button> <a href=/ class=navbar-brand>Toon Verwerft</a></div><nav class="collapse navbar-collapse bs-navbar-collapse" role=navigation><ul class="nav navbar-nav"><li><a href=/ >Home</a></li><li><a href=https://twitter.com/toonverwerft>Twitter</a></li><li><a href=https://github.com/veewee/ >Github</a></li><li><a href=https://www.linkedin.com/in/toonverwerft>LinkedIn</a></li><li><a href=https://phpc.social/@veewee>PHPC.Social</a></li><li><a href=https://speakerdeck.com/veewee>Talks</a></li></ul></nav></div></header><a name=#content></a><div id=content><div class=container><div class=row><div class="col-xs-12 col-sm-8 col-md-9 left-pane"><div class=post-details><h1>Hijacking your code with streams</h1><div class=pull-right><span class="meta label label-info">26 Oct 2015</span></div><small>Tags: <span class="label label-primary tag">php</span> <span class="label label-primary tag">streams</span></small><div class=post><img src=/images/blog/20151026/hijacking.jpg class=post-banner alt=""><p>Lately, you might have noticed that streams are getting more important in the PHP scene. They are for example widely used in <a href=http://www.php-fig.org/psr/psr-7/ target=_blank>PSR-7</a> and implemented in <a href=https://github.com/zendframework/zend-diactoros target=_blank>Diactoros</a>. Yesterday I was scrolling down the issues list of <a href=http://phpspec.readthedocs.org/en/latest/ target=_blank>Phpspec</a> and bumped in on <a href=https://github.com/phpspec/phpspec/pull/788 target=_blank>this pull request</a>. This pull request shows that it is possible to convert code in-memory and later require the modified content to be executed. Wow, that is awesome! Let's take a look at it.</p><h2 id=the-concept>The concept</h2><p>You probably already used some built-in PHP streams like regular files, `php://memory` or `data://...` in combination with the `fopen()` method or the `StdFileObject` class. Beside those built-in streams, it is possible to configure your own stream wrappers. For this post I will be creating a blacklist stream that will remove blacklisted methods from your code. The blacklist stream wrapper will read a PHP file and replaces blacklisted methods from the code. When the file is required through the blacklist wrapper, all blacklisted methods will be removed from the code.</p><h2 id=show-me-some-code>Show me some code</h2><figure class=highlight><pre><code class=language-php data-lang=php><span class=cp>&lt;?php</span>

<span class=kd>class</span> <span class=nc>StreamWrapper</span>
<span class=p>{</span>

    <span class=k>private</span> <span class=nv>$realPath</span><span class=p>;</span>
    <span class=k>private</span> <span class=nv>$fileResource</span><span class=p>;</span>
    <span class=k>private</span> <span class=k>static</span> <span class=nv>$blacklistedMethods</span> <span class=o>=</span> <span class=p>[];</span>

    <span class=k>public</span> <span class=k>static</span> <span class=k>function</span> <span class=n>blacklistMethod</span><span class=p>(</span><span class=nv>$method</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=k>self</span><span class=o>::</span><span class=nv>$blacklistedMethods</span><span class=p>[]</span> <span class=o>=</span> <span class=nv>$method</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=n>stream_open</span><span class=p>(</span><span class=nv>$path</span><span class=p>,</span> <span class=nv>$mode</span><span class=p>,</span> <span class=nv>$options</span><span class=p>,</span> <span class=o>&amp;</span><span class=nv>$opened_path</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=n>realPath</span> <span class=o>=</span> <span class=nb>preg_replace</span><span class=p>(</span><span class=s1>'|^blacklist://|'</span><span class=p>,</span> <span class=s1>''</span><span class=p>,</span> <span class=nv>$path</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nb>file_exists</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=n>realPath</span><span class=p>))</span> <span class=p>{</span>
            <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=nv>$content</span> <span class=o>=</span> <span class=nb>file_get_contents</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=n>realPath</span><span class=p>);</span>
        <span class=k>foreach</span> <span class=p>(</span><span class=k>self</span><span class=o>::</span><span class=nv>$blacklistedMethods</span> <span class=k>as</span> <span class=nv>$blacklistedMethod</span><span class=p>)</span> <span class=p>{</span>
            <span class=nv>$content</span> <span class=o>=</span> <span class=nb>preg_replace</span><span class=p>(</span><span class=s1>'/^'</span> <span class=mf>.</span> <span class=nv>$blacklistedMethod</span> <span class=mf>.</span> <span class=s1>'\([^\)]*\);$/im'</span><span class=p>,</span> <span class=s1>''</span><span class=p>,</span> <span class=nv>$content</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=nv>$this</span><span class=o>-&gt;</span><span class=n>fileResource</span> <span class=o>=</span> <span class=nb>fopen</span><span class=p>(</span><span class=s1>'php://memory'</span><span class=p>,</span> <span class=s1>'w+'</span><span class=p>);</span>
        <span class=nb>fwrite</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=n>fileResource</span><span class=p>,</span> <span class=nv>$content</span><span class=p>);</span>
        <span class=nb>rewind</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=n>fileResource</span><span class=p>);</span>

        <span class=nv>$opened_path</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=n>realPath</span><span class=p>;</span>
        <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=n>stream_stat</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=k>return</span> <span class=nb>stat</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=n>realPath</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=n>stream_read</span><span class=p>(</span><span class=nv>$count</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=k>return</span> <span class=nb>fread</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=n>fileResource</span><span class=p>,</span> <span class=nv>$count</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=n>stream_eof</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=k>return</span> <span class=nb>feof</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=n>fileResource</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span></code></pre></figure><h2 id=usage>Usage</h2><p>To use the stream wrapper, you have to register it with the name blacklist. Next you can require the file with the new stream URL. Internally PHP will open the file with your custom stream reader. This means that you can alter the content of the PHP file in an in-memory stream which will be used by PHP. Here is what the file looks like.</p><figure class=highlight><pre><code class=language-php data-lang=php><span class=cp>&lt;?php</span>
<span class=c1>// run.php</span>

<span class=k>require</span><span class=p>(</span><span class=s1>'StreamWrapper.php'</span><span class=p>);</span>
<span class=nc>StreamWrapper</span><span class=o>::</span><span class=nf>blacklistMethod</span><span class=p>(</span><span class=s1>'die'</span><span class=p>);</span>
<span class=nb>stream_wrapper_register</span><span class=p>(</span><span class=s1>'blacklist'</span><span class=p>,</span> <span class=s1>'StreamWrapper'</span><span class=p>);</span>

<span class=k>require</span> <span class=s1>'blacklist://test.php'</span><span class=p>;</span></code></pre></figure><p>The above code needs a file test.php. This file looks like this:</p><figure class=highlight><pre><code class=language-php data-lang=php><span class=cp>&lt;?php</span>
<span class=c1>// test.php</span>

<span class=k>die</span><span class=p>(</span><span class=s1>'now you see me ...'</span><span class=p>);</span>
<span class=k>echo</span><span class=p>(</span><span class=s1>'now you dont!'</span><span class=p>);</span></code></pre></figure><p>When executing the <code class="language-plaintext highlighter-rouge">run.php</code> you will see the result:</p><figure class=highlight><pre><code class=language-sh data-lang=sh><span class=nv>$ </span>php run.php
now you dont!</code></pre></figure><h2 id=what-the-hell-did-i-just-read>What the hell did I just read…</h2><p>I know, most projects won't need in-memory code adjustments. The blacklist wrapper in this post will probably never be needed, but it is used to show you what is possible. Streams are pretty cool and will probably become more important in the future.</p></div><a name=comments></a><div id=disqus_thread></div><script type=text/javascript>var disqus_identifier = '/blog/hijacking-your-code-with-streams/';
        var disqus_title = 'Hijacking your code with streams';
        var disqus_url = 'http://veewee.github.io/blog/hijacking-your-code-with-streams/';

        // trigger disqus-comments.js
        var embed_disqus_comments = true;</script></div></div><div class="col-xs-12 col-sm-4 col-md-3 right-pane"><h1>whois <small>VeeWee</small></h1><div><img src=/images/picture.png class="img-thumbnail img-responsive selfie" alt=Selfie></div><div><h2>Hi there!</h2><p>Glad you made it to my blog. Please feel free to take a look around. You will find some interesting stuff, mostly about web development and PHP.</p><p>Still can't get enough of me? Quick! Take a look at my <a href=https://speakerdeck.com/veewee>Speakerdeck</a>, <a href=https://twitter.com/toonverwerft>Twitter</a>, <a rel=me href=https://phpc.social/@veewee>PHPC.Social</a>, or <a href=https://github.com/veewee/ >Github</a> account.</p></div><div class=list-group><a class=list-group-item href=//github.com/veewee/veewee.github.io/issues/new><span class="glyphicon glyphicon-pencil"></span> Contact Me </a><a class=list-group-item href=/atom.xml><span class="glyphicon glyphicon-pushpin"></span> Subscribe to RSS</a></div></div></div></div></div><script src=/js/vendor.js></script><script src=/js/blog.js></script></body></html>