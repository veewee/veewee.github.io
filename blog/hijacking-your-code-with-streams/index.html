<!DOCTYPE html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>Hijacking your code with streams</title><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel=stylesheet href=/css/a862.blog.css><!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]--><link rel=apple-touch-icon-precomposed sizes=144x144 href=/images/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.ico><link rel=alternate type=application/atom+xml title="Toon Verwerft" href=https://veewee.github.io/atom.xml></head><body class=bs-docs-home><a class=sr-only href=#content>Skip to main content</a><header class="navbar navbar-inverse navbar-fixed-top bs-docs-nav" role=banner><div class=container><div class=navbar-header><button class=navbar-toggle type=button data-toggle=collapse data-target=.bs-navbar-collapse><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button> <a href="/" class=navbar-brand>Toon Verwerft</a></div><nav class="collapse navbar-collapse bs-navbar-collapse" role=navigation><ul class="nav navbar-nav"><li><a href="/">Home</a></li><li><a href=//twitter.com/toonverwerft>Twitter</a></li><li><a href="//github.com/veewee/">Github</a></li><li><a href=//www.linkedin.com/pub/toon-verwerft/36/b90/a2b>LinkedIn</a></li></ul></nav></div></header><a name=#content></a><div id=content><div class=container><div class=row><div class="col-xs-12 col-sm-8 col-md-9 left-pane"><div class=post-details><h1>Hijacking your code with streams</h1><div class=pull-right><span class="meta label label-info">26 Oct 2015</span></div><small>Tags: <a href=/tags/php class="label label-primary tag" title="View posts tagged with &quot;php&quot;">php</a> <a href=/tags/streams class="label label-primary tag" title="View posts tagged with &quot;streams&quot;">streams</a></small><div class=post><img src=/images/blog/20151026/e5b7.hijacking.jpg class=post-banner alt=""><p>Lately, you might have noticed that streams are getting more important in the PHP scene. They are for example widely used in <a href="http://www.php-fig.org/psr/psr-7/" target=_blank>PSR-7</a> and implemented in <a href=https://github.com/zendframework/zend-diactoros target=_blank>Diactoros</a>. Yesterday I was scrolling down the issues list of <a href="http://phpspec.readthedocs.org/en/latest/" target=_blank>Phpspec</a> and bumped in on <a href=https://github.com/phpspec/phpspec/pull/788 target=_blank>this pull request</a>. This pull request shows that it is possible to convert code in-memory and later require the modified content to be executed. Wow, that is awesome! Let's take a look at it.</p><h2>The concept</h2><p>You probably already used some built-in PHP streams like regular files, `php://memory` or `data://...` in combination with the `fopen()` method or the `StdFileObject` class. Beside those built-in streams, it is possible to configure your own stream wrappers. For this post I will be creating a blacklist stream that will remove blacklisted methods from your code. The blacklist stream wrapper will read a PHP file and replaces blacklisted methods from the code. When the file is required through the blacklist wrapper, all blacklisted methods will be removed from the code.</p><h2>Show me some code</h2><div class=highlight><pre><code class=php><span class=cp>&lt;?php</span>

<span class=k>class</span> <span class=nc>StreamWrapper</span>
<span class=p>{</span>

    <span class=k>private</span> <span class=nv>$realPath</span><span class=p>;</span>
    <span class=k>private</span> <span class=nv>$fileResource</span><span class=p>;</span>
    <span class=k>private</span> <span class=k>static</span> <span class=nv>$blacklistedMethods</span> <span class=o>=</span> <span class=p>[];</span>

    <span class=k>public</span> <span class=k>static</span> <span class=k>function</span> <span class=nf>blacklistMethod</span><span class=p>(</span><span class=nv>$method</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nx>self</span><span class=o>::</span><span class=nv>$blacklistedMethods</span><span class=p>[]</span> <span class=o>=</span> <span class=nv>$method</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>stream_open</span><span class=p>(</span><span class=nv>$path</span><span class=p>,</span> <span class=nv>$mode</span><span class=p>,</span> <span class=nv>$options</span><span class=p>,</span> <span class=o>&amp;</span><span class=nv>$opened_path</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>realPath</span> <span class=o>=</span> <span class=nb>preg_replace</span><span class=p>(</span><span class=s1>&#39;|^blacklist://|&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=nv>$path</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nb>file_exists</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>realPath</span><span class=p>))</span> <span class=p>{</span>
            <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=nv>$content</span> <span class=o>=</span> <span class=nb>file_get_contents</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>realPath</span><span class=p>);</span>
        <span class=k>foreach</span> <span class=p>(</span><span class=nx>self</span><span class=o>::</span><span class=nv>$blacklistedMethods</span> <span class=k>as</span> <span class=nv>$blacklistedMethod</span><span class=p>)</span> <span class=p>{</span>
            <span class=nv>$content</span> <span class=o>=</span> <span class=nb>preg_replace</span><span class=p>(</span><span class=s1>&#39;/^&#39;</span> <span class=o>.</span> <span class=nv>$blacklistedMethod</span> <span class=o>.</span> <span class=s1>&#39;\([^\)]*\);$/im&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=nv>$content</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>fileResource</span> <span class=o>=</span> <span class=nb>fopen</span><span class=p>(</span><span class=s1>&#39;php://memory&#39;</span><span class=p>,</span> <span class=s1>&#39;w+&#39;</span><span class=p>);</span>
        <span class=nb>fwrite</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>fileResource</span><span class=p>,</span> <span class=nv>$content</span><span class=p>);</span>
        <span class=nb>rewind</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>fileResource</span><span class=p>);</span>

        <span class=nv>$opened_path</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>realPath</span><span class=p>;</span>
        <span class=k>return</span> <span class=k>true</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>stream_stat</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=k>return</span> <span class=nb>stat</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>realPath</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>stream_read</span><span class=p>(</span><span class=nv>$count</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=k>return</span> <span class=nb>fread</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>fileResource</span><span class=p>,</span> <span class=nv>$count</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>stream_eof</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=k>return</span> <span class=nb>feof</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>fileResource</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><h2>Usage</h2><p>To use the stream wrapper, you have to register it with the name blacklist. Next you can require the file with the new stream URL. Internally PHP will open the file with your custom stream reader. This means that you can alter the content of the PHP file in an in-memory stream which will be used by PHP. Here is what the file looks like.</p><div class=highlight><pre><code class=php><span class=cp>&lt;?php</span>
<span class=c1>// run.php</span>

<span class=k>require</span><span class=p>(</span><span class=s1>&#39;StreamWrapper.php&#39;</span><span class=p>);</span>
<span class=nx>StreamWrapper</span><span class=o>::</span><span class=na>blacklistMethod</span><span class=p>(</span><span class=s1>&#39;die&#39;</span><span class=p>);</span>
<span class=nx>stream_wrapper_register</span><span class=p>(</span><span class=s1>&#39;blacklist&#39;</span><span class=p>,</span> <span class=s1>&#39;StreamWrapper&#39;</span><span class=p>);</span>

<span class=k>require</span> <span class=s1>&#39;blacklist://test.php&#39;</span><span class=p>;</span>
</code></pre></div><p>The above code needs a file test.php. This file looks like this:</p><div class=highlight><pre><code class=php><span class=cp>&lt;?php</span>
<span class=c1>// test.php</span>

<span class=k>die</span><span class=p>(</span><span class=s1>&#39;now you see me ...&#39;</span><span class=p>);</span>
<span class=k>echo</span><span class=p>(</span><span class=s1>&#39;now you dont!&#39;</span><span class=p>);</span>
</code></pre></div><p>When executing the <code>run.php</code> you will see the result:</p><div class=highlight><pre><code class=sh><span class=nv>$ </span>php run.php
now you dont!
</code></pre></div><h2>What the hell did I just read...</h2><p>I know, most projects won't need in-memory code adjustments. The blacklist wrapper in this post will probably never be needed, but it is used to show you what is possible. Streams are pretty cool and will probably become more important in the future.</p></div><div class="social clearfix"><div class=addthis_inline_share_toolbox></div><div id=atstbx_flattr class="at-share-tbx-element addthis-smartlayers addthis-animated at4-show"><div class=at-share-btn-elements><a role=button class="at-icon-wrapper at-share-btn flattr" href="https://flattr.com/submit/auto?fid=vo26re&url=http%3A%2F%2Fveewee.github.io%2Fblog%2Fhijacking-your-code-with-streams" target=_blank><span class=at4-visually-hidden>Flattr this</span><span class=at-icon-wrapper style=""><svg xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink version=1.1 id=Capa_1 x=0px y=0px width=22px height=22px viewbox="0 0 533.333 533.333" style="enable-background:new 0 0 533.333 533.333" xml:space=preserve><g><path d="M191.438,0C64.689,0,0,73.001,0,209.3l0,0v95.211v190.745L124.161,370.97V225.711c0-56.466,14.964-92.399,65.166-100.466   l0,0c17.538-3.429,54.037-2.228,77.243-2.228l0,0v86.248c0,0.786,0.107,2.191,0.31,2.909l0,0c0.974,3.492,4.13,6.05,7.872,6.058   l0,0c2.116,0.004,4.098-1.096,6.143-3.109l0,0L496.06,0.033L351.627,0H191.438z M409.171,162.368v145.255   c0,56.466-14.967,92.403-65.164,100.466l0,0c-17.537,3.429-54.04,2.229-77.246,2.229l0,0V324.07c0-0.781-0.107-2.191-0.31-2.907   l0,0c-0.971-3.496-4.126-6.055-7.871-6.058l0,0c-2.117-0.004-4.097,1.1-6.141,3.107l0,0L37.271,533.299l144.431,0.034h160.191   c126.747,0,191.44-73.004,191.44-209.298l0,0V228.82V38.083L409.171,162.368z" fill=#FFFFFF></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g></svg></span><span class=at-label>Flattr</span></a></div></div></div><a name=comments></a><div id=disqus_thread></div><script type=text/javascript>var disqus_identifier = '/blog/hijacking-your-code-with-streams';
        var disqus_title = 'Hijacking your code with streams';
        var disqus_url = 'http://veewee.github.io/blog/hijacking-your-code-with-streams';

        // trigger disqus-comments.js
        var embed_disqus_comments = true;</script></div></div><div class="col-xs-12 col-sm-4 col-md-3 right-pane"><h1>whois <small>VeeWee</small></h1><div><img src=/images/5f0f.picture.png class="img-thumbnail img-responsive selfie" alt=Selfie></div><div><h2>Hi there!</h2><p>Glad you made it to my blog. Please feel free to take a look around. You will find some interesting stuff, mostly about web development and PHP.</p><p>Still can't get enough of me? Quick! Take a look at my <a href=//twitter.com/toonverwerft>Twitter</a> and <a href="//github.com/veewee/">Github</a> account.</p></div><div class=list-group><a class=list-group-item href=//github.com/veewee/veewee.github.io/issues/new><span class="glyphicon glyphicon-pencil"></span> Contact Me</a> <a class=list-group-item href=/atom.xml><span class="glyphicon glyphicon-pushpin"></span> Subscribe to RSS</a></div></div></div></div></div><script src=/js/b1a7.vendor.js></script><script src=/js/e51f.blog.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-57d8dc41723aa026"></script></body></html>