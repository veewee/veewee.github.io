<!DOCTYPE html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>Writing your first Grunt plugin</title><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel=stylesheet href=/css/cbf3.blog.css><!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]--><link rel=apple-touch-icon-precomposed sizes=144x144 href=/images/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.ico><link rel=alternate type=application/atom+xml title="Toon Verwerft" href=https://veewee.github.io/atom.xml></head><body class=bs-docs-home><a class=sr-only href=#content>Skip to main content</a><header class="navbar navbar-inverse navbar-fixed-top bs-docs-nav" role=banner><div class=container><div class=navbar-header><button class=navbar-toggle type=button data-toggle=collapse data-target=.bs-navbar-collapse><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button> <a href=/ class=navbar-brand>Toon Verwerft</a></div><nav class="collapse navbar-collapse bs-navbar-collapse" role=navigation><ul class="nav navbar-nav"><li><a href=/>Home</a></li><li><a href=//twitter.com/toonverwerft>Twitter</a></li><li><a href=//github.com/veewee/>Github</a></li><li><a href=//www.linkedin.com/pub/toon-verwerft/36/b90/a2b>LinkedIn</a></li></ul></nav></div></header><a name=#content></a><div id=content><div class=container><div class=row><div class="col-xs-12 col-sm-8 col-md-9 left-pane"><div class=post-details><h1>Writing your first Grunt plugin</h1><div class=pull-right><span class="meta label label-info">27 Apr 2014</span></div><small>Tags: <a href=/tags/grunt class="label label-primary tag" title="View posts tagged with &quot;grunt&quot;">grunt</a> <a href=/tags/plugin class="label label-primary tag" title="View posts tagged with &quot;plugin&quot;">plugin</a></small><div class=post><img src=/images/blog/20140427/0dd5.grunt.jpg class=post-banner alt=""><p>For one of my projects, I needed a tool to list all used translations keys from a PHP project. Because I want to keep the translation database clean, I decided to create a <a href=http://gruntjs.com/ target=_blank>Grunt</a> plugin. There was one big problem: How do you create a Grunt plugin? So I started to read the documentation, some blog posts, etc. and noticed that the documentation was pretty confusing for beginners like me. Let me take you on a tour through my first plugin.</p><h2>Where to start?</h2><h3>Create the plugin skeleton</h3><p>The Grunt team has created a tool called <a href=http://gruntjs.com/project-scaffolding target=_blank>grunt-init</a>. It&#39;s purpose is to quickly scaffold your project with some basic templates. The tool does not include any templates, so you have to download them manually. There is a tempalte for creating a <a href=https://github.com/gruntjs/grunt-init-gruntplugin target=_blank>grunt-plugin</a> and another one to add a <a href=https://github.com/gruntjs/grunt-init-gruntfile target=_blank>Gruntfile</a> to your project. When you run the tool, a wizard is launched to personalize the template.</p><div class=highlight><pre><code class=sh><span class=nv>$ </span>grunt-init gruntplugin
</code></pre></div><p>After running this command, all the template files are being copied to your folder. The structure is pretty straight forward. There is a <code>tasks</code> folder which contains the Grunt tasks. Another folder is the <code>test</code> folder. This is the place where you write some node tests for your plugin. Finally, there is also a Gruntfile which will help you with some basic tasks like testing the plugin.</p><h3>Configure NPM</h3><p>Once you got through the installation wizard, you should personalize the NPM file. My plugin is heavy project specific, so I decided to make it a private repository. I also like using <a href=http://lodash.com/ target=_blank>Lo-Dash</a> for handling arrays, so I added this one as a dependency of the plugin. All these parameters can be configured in the <code>package.json</code> file.</p><div class=highlight><pre><code class=js>  <span class=s2>&quot;private&quot;</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
  <span class=s2>&quot;dependencies&quot;</span><span class=o>:</span> <span class=p>{</span>
    <span class=s2>&quot;lodash&quot;</span><span class=o>:</span> <span class=s2>&quot;~2.4.1&quot;</span>
  <span class=p>},</span>
</code></pre></div><p>When the configuration is saved, the next step is to install the dependencies. This can be done by running the command:</p><div class=highlight><pre><code class=sh><span class=nv>$ </span>npm install
</code></pre></div><h2>Writing the task</h2><h3>Task structure</h3><p>You can add one or more tasks to your plugin. By default there is one <a href=http://gruntjs.com/creating-tasks#multi-tasks target=_blank>multi-task</a> in the tasks folder. It looks like this:</p><div class=highlight><pre><code class=js><span class=s1>&#39;use strict&#39;</span><span class=p>;</span>

<span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>grunt</span><span class=p>)</span> <span class=p>{</span>
  <span class=nx>grunt</span><span class=p>.</span><span class=nx>registerMultiTask</span><span class=p>(</span><span class=s1>&#39;findTranslations&#39;</span><span class=p>,</span> <span class=s1>&#39;Find all translations in your project.&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>

    <span class=c1>// The task code comes here</span>

  <span class=p>};</span>
<span class=p>};</span>
</code></pre></div><h3>Initialize dependencies</h3><p>Grunt has some standard tools to handle <a href=http://gruntjs.com/api/grunt.file target=_blank>file</a> actions and <a href=http://gruntjs.com/api/grunt.log target=_blank>logging</a>. When you want to use custom libraries, you can include them through <a href=http://requirejs.org/ target=_blank>require</a>.</p><div class=highlight><pre><code class=js>    <span class=kd>var</span> <span class=nx>_</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;lodash&#39;</span><span class=p>);</span>
</code></pre></div><h3>Options</h3><p>If you ever worked with Grunt before, you know that all commands are configurable. Some of the options will have a default value. In the plugin, you can add custom <a href=http://gruntjs.com/api/grunt.option>options</a> as followed:</p><div class=highlight><pre><code class=js>    <span class=kd>var</span> <span class=nx>options</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>options</span><span class=p>({</span>
      <span class=nx>format</span><span class=o>:</span> <span class=s1>&#39;json&#39;</span><span class=p>,</span>
    <span class=p>});</span>
</code></pre></div><p>The options in the object are the default options and can be overwritten in the Gruntfile.</p><h3>Files</h3><p>Next to the options, there is a basic configuration parameter to specify source and destinations files.The configuration looks like:</p><div class=highlight><pre><code class=js>  <span class=nx>files</span><span class=o>:</span> <span class=p>[</span>
    <span class=p>{</span>
      <span class=nx>src</span><span class=o>:</span> <span class=p>[</span>
        <span class=s1>&#39;test/fixtures/php-controller-plugin&#39;</span><span class=p>,</span>
      <span class=p>],</span>
      <span class=nx>dest</span><span class=o>:</span> <span class=s1>&#39;tmp/translations-json&#39;</span>
  <span class=p>}</span>
<span class=p>],</span>
</code></pre></div><p>As you can see, it is possible to add multiple src / dest collections. The source can consist out of multiple files and the names can contain regular expressions like wildcards. In the plugin, it is very easy to loop through the files:</p><div class=highlight><pre><code class=js>    <span class=k>this</span><span class=p>.</span><span class=nx>files</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>f</span><span class=p>)</span> <span class=p>{</span>

      <span class=kd>var</span> <span class=nx>translations</span> <span class=o>=</span> <span class=p>[];</span>
      <span class=nx>f</span><span class=p>.</span><span class=nx>src</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>filePath</span><span class=p>)</span> <span class=p>{</span>
        <span class=kd>var</span> <span class=nx>content</span> <span class=o>=</span> <span class=nx>grunt</span><span class=p>.</span><span class=nx>file</span><span class=p>.</span><span class=nx>read</span><span class=p>(</span><span class=nx>filePath</span><span class=p>);</span>
        <span class=c1>// Todo: Find translation keys</span>
      <span class=p>});</span>

      <span class=nx>grunt</span><span class=p>.</span><span class=nx>file</span><span class=p>.</span><span class=nx>write</span><span class=p>(</span><span class=nx>f</span><span class=p>.</span><span class=nx>dest</span><span class=p>,</span> <span class=nx>translations</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=s2>&quot;\n&quot;</span><span class=p>);</span>
    <span class=p>});</span>
</code></pre></div><h3>Locating translation keys</h3><p>To find the translation keys in a file, I needed to write some regular expressions to find the key. Luckily for me, I use a very basic translation method. In my project I have 2 different ways of retrieving translations: one for the controller and one for the view.</p><div class=highlight><pre><code class=js>    <span class=kd>var</span> <span class=nx>translationKeyRegex</span> <span class=o>=</span> <span class=s2>&quot;[\s]?.*[\\\&#39;\\\&quot;]{1}([a-z0-9\\-\\_]*)[\\\&#39;\\\&quot;]{1}[\s]?.*&quot;</span><span class=p>;</span>
    <span class=kd>var</span> <span class=nx>regexs</span> <span class=o>=</span> <span class=p>{</span>
      <span class=s1>&#39;phpControllerPlugin&#39;</span><span class=o>:</span> <span class=s2>&quot;translator-&gt;get\\(&quot;</span> <span class=o>+</span> <span class=nx>translationKeyRegex</span> <span class=o>+</span> <span class=s2>&quot;\\)&quot;</span><span class=p>,</span>
      <span class=s1>&#39;phpViewHelper&#39;</span><span class=o>:</span> <span class=s2>&quot;_t-&gt;get\\(&quot;</span> <span class=o>+</span> <span class=nx>translationKeyRegex</span> <span class=o>+</span> <span class=s2>&quot;\\)&quot;</span>
    <span class=p>};</span>
</code></pre></div><p>This may look a bit hard at first, but it is actually very easy. There are only 2 patterns:</p><ul><li>In the controller: <code>$translator-&gt;get(&#39;KEY_123&#39;);</code></li><li>In the view: <code>_t-&gt;get(&#39;KEY_123&#39;);</code></li></ul><p>After the regular expressions were written, I created a function that returns the translation keys:</p><div class=highlight><pre><code class=js>    <span class=kd>var</span> <span class=nx>findTranslationKeys</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>content</span><span class=p>,</span> <span class=nx>regex</span><span class=p>)</span> <span class=p>{</span>
      <span class=kd>var</span> <span class=nx>found</span> <span class=o>=</span> <span class=p>[];</span>
      <span class=kd>var</span> <span class=nx>match</span><span class=p>;</span>

      <span class=k>while</span> <span class=p>((</span><span class=nx>match</span> <span class=o>=</span> <span class=nx>regex</span><span class=p>.</span><span class=nx>exec</span><span class=p>(</span><span class=nx>content</span><span class=p>))</span> <span class=o>!==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=nx>found</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>match</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
      <span class=p>}</span>

      <span class=k>return</span> <span class=nx>found</span><span class=p>;</span>
    <span class=p>};</span>
</code></pre></div><p>Okay, the hard part of the plugin is written. Now the only thing left is adding this functionality to the part where we read the file. I want to execute all regular expressions patterns on every file. The resulting array should only contain unique entries. This can easily be done with the Lo-Dash forEach and union method:</p><div class=highlight><pre><code class=js>  <span class=kd>var</span> <span class=nx>found</span><span class=p>,</span> <span class=nx>regex</span><span class=p>;</span>
  <span class=nx>_</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>regexs</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>expression</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>regex</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>expression</span><span class=p>,</span> <span class=s1>&#39;gi&#39;</span><span class=p>);</span>
    <span class=nx>found</span> <span class=o>=</span> <span class=nx>findTranslationKeys</span><span class=p>(</span><span class=nx>content</span><span class=p>,</span> <span class=nx>regex</span><span class=p>);</span>

    <span class=c1>// Only use unique translation keys:</span>
    <span class=nx>translations</span> <span class=o>=</span> <span class=nx>_</span><span class=p>.</span><span class=nx>union</span><span class=p>(</span><span class=nx>translations</span><span class=p>,</span> <span class=nx>found</span><span class=p>);</span>
  <span class=p>});</span>
</code></pre></div><h3>Formatting the output</h3><p>As you can see in the files part, at the moment we only output the result as newline-separated text. Because I want to clean up my database through PHP, I decided to make JSON the default format. To specify which format will be used I added one other function:</p><div class=highlight><pre><code class=js>    <span class=kd>var</span> <span class=nx>formatTranslations</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>translations</span><span class=p>,</span> <span class=nx>format</span><span class=p>)</span> <span class=p>{</span>
      <span class=kd>var</span> <span class=nx>formatted</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
      <span class=k>switch</span><span class=p>(</span><span class=nx>format</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>case</span> <span class=s1>&#39;newlines&#39;</span><span class=o>:</span>
          <span class=nx>formatted</span> <span class=o>=</span> <span class=nx>translations</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=s2>&quot;\n&quot;</span><span class=p>);</span>
          <span class=k>break</span><span class=p>;</span>
        <span class=k>case</span> <span class=s1>&#39;json&#39;</span><span class=o>:</span>
          <span class=nx>formatted</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>translations</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=mi>4</span><span class=p>);</span>
          <span class=k>break</span><span class=p>;</span>
        <span class=k>default</span><span class=o>:</span>
          <span class=nx>formatted</span> <span class=o>=</span> <span class=s1>&#39;Invalid export format&#39;</span><span class=p>;</span>
          <span class=k>break</span><span class=p>;</span>
      <span class=p>}</span>
      <span class=k>return</span> <span class=nx>formatted</span><span class=p>;</span>
    <span class=p>};</span>
</code></pre></div><p>The translations parameter is the array of found translation keys and the format is configured in the <code>options.format</code> variable.</p><h3>Logging</h3><p>At the end of the command, I find it useful to log the results of the task. In this case, I only print an indication of the amount of found items.</p><div class=highlight><pre><code class=js>    <span class=nx>grunt</span><span class=p>.</span><span class=nx>log</span><span class=p>.</span><span class=nx>writeln</span><span class=p>(</span><span class=s1>&#39;Saved &#39;</span> <span class=o>+</span> <span class=nx>translations</span><span class=p>.</span><span class=nx>length</span> <span class=o>+</span> <span class=s1>&#39; translation keys to file &#39;</span> <span class=o>+</span> <span class=nx>f</span><span class=p>.</span><span class=nx>dest</span><span class=p>);</span>
</code></pre></div><h2>Testing</h2><p>For now, I only talked about writing the plugin. Of course it is also recommended to write some test for your plugin. As far as I can see in other plugins, there are only functional tests. In the test directory there are 2 folders. The <code>fixtures</code> folder is where you add the files where you want to find translation keys in. In the <code>expected</code> folder you place the output file that you expect the plugin to generate.</p><p>Now the first thing that you need to do, is to configure your task in the Gruntfile. When you run the test command, your configured tasks will run first. So in the tasks you can configure to run the tasks with the fixtures file and save it in a <code>tmp</code> folder. When you know which files are being read and written, it is easy to create your test:</p><div class=highlight><pre><code class=js>  <span class=nx>json_format</span><span class=o>:</span> <span class=kd>function</span><span class=p>(</span><span class=nx>test</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>test</span><span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>

    <span class=kd>var</span> <span class=nx>actual</span> <span class=o>=</span> <span class=nx>grunt</span><span class=p>.</span><span class=nx>file</span><span class=p>.</span><span class=nx>read</span><span class=p>(</span><span class=s1>&#39;tmp/translations-json&#39;</span><span class=p>);</span>
    <span class=kd>var</span> <span class=nx>expected</span> <span class=o>=</span> <span class=nx>grunt</span><span class=p>.</span><span class=nx>file</span><span class=p>.</span><span class=nx>read</span><span class=p>(</span><span class=s1>&#39;test/expected/json_format&#39;</span><span class=p>);</span>
    <span class=nx>test</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=nx>actual</span><span class=p>,</span> <span class=nx>expected</span><span class=p>,</span> <span class=s1>&#39;should return translations in json.&#39;</span><span class=p>);</span>

    <span class=nx>test</span><span class=p>.</span><span class=nx>done</span><span class=p>();</span>
  <span class=p>},</span>
</code></pre></div><p>Now the only command you need to run to test your code is:</p><div class=highlight><pre><code class=sh><span class=nv>$ </span>grunt <span class=nb>test</span>
</code></pre></div><h2>Deployment</h2><p>Once your plugin is ready, you want to place it in GIT. Because this is a private repository, I placed it on a private repository on BitBucket. Now the next problem arose: How can I load my custom plugin through NPM in another project? In the latest versions of NPM, it is possible to add packages that are not managed on NPM. The real problem is that it is a private repository. After some searching, I found out that the only good way the require the package is to use the SSH url of the package. This is what I placed in the <code>package.json</code> file of the main project.</p><div class=highlight><pre><code class=js>  <span class=s2>&quot;devDependencies&quot;</span><span class=o>:</span> <span class=p>{</span>
    <span class=s2>&quot;grunt-find-bo-translations&quot;</span><span class=o>:</span> <span class=s2>&quot;git+ssh://git@bitbucket.org:organization/package.git&quot;</span>
  <span class=p>}</span>
</code></pre></div><p><strong>Note:</strong> Don&#39;t forget to <code>npm install</code></p><p>In the Gruntfile of the project, I configured the task to search for translations in all .php and .phtml files. The result of the tasks will be saved in the logs folder.</p><div class=highlight><pre><code class=js>    <span class=nx>findTranslations</span><span class=o>:</span> <span class=p>{</span>
      <span class=nx>json_format</span><span class=o>:</span> <span class=p>{</span>
        <span class=nx>options</span><span class=o>:</span> <span class=p>{</span>
            <span class=nx>format</span><span class=o>:</span> <span class=s1>&#39;json&#39;</span><span class=p>,</span>
        <span class=p>},</span>
        <span class=nx>files</span><span class=o>:</span> <span class=p>[</span>
          <span class=p>{</span>
            <span class=nx>src</span><span class=o>:</span> <span class=p>[</span>
              <span class=s1>&#39;{,*/}*.php&#39;</span><span class=p>,</span>
              <span class=s1>&#39;{,*/}*.phtml&#39;</span><span class=p>,</span>
            <span class=p>],</span>
            <span class=nx>dest</span><span class=o>:</span> <span class=s1>&#39;logs/translation-keys.json&#39;</span>
          <span class=p>}</span>
        <span class=p>],</span>
      <span class=p>},</span>
    <span class=p>},</span>
</code></pre></div><p>Finally my task was ready to use in my project:</p><div class=highlight><pre><code class=sh><span class=nv>$ </span>grunt findTranslations

&gt;&gt; Running <span class=s2>&quot;findTranslations:json_format&quot;</span> <span class=o>(</span>findTranslations<span class=o>)</span> task
&gt;&gt; Saved 250 translation keys to file logs/translation-keys.json
</code></pre></div></div><a name=comments></a><div id=disqus_thread></div><script type=text/javascript>var disqus_identifier = '/blog/writing-your-first-grunt-plugin';
        var disqus_title = 'Writing your first Grunt plugin';
        var disqus_url = 'http://veewee.github.io/blog/writing-your-first-grunt-plugin';

        // trigger disqus-comments.js
        var embed_disqus_comments = true;</script></div></div><div class="col-xs-12 col-sm-4 col-md-3 right-pane"><h1>whois <small>VeeWee</small></h1><div><img src=/images/1da7.picture.png class="img-thumbnail img-responsive selfie" alt=Selfie></div><div><h2>Hi there!</h2><p>Glad you made it to my blog. Please feel free to take a look around. You will find some interesting stuff, mostly about web development and PHP.</p><p>Still can't get enough of me? Quick! Take a look at my <a href=//twitter.com/toonverwerft>Twitter</a> and <a href=//github.com/veewee/>Github</a> account.</p></div><div class=list-group><a class=list-group-item href=//github.com/veewee/veewee.github.io/issues/new><span class="glyphicon glyphicon-pencil"></span> Contact Me</a> <a class=list-group-item href=/atom.xml><span class="glyphicon glyphicon-pushpin"></span> Subscribe to RSS</a></div></div></div></div></div><script src=/js/dd0a.vendor.js></script><script src=/js/e51f.blog.js></script></body></html>